# Master Admin Commands

**‚ö†Ô∏è This file contains sensitive admin commands. Do NOT commit to git.**

This file documents SQL commands for emergency system controls that can be executed instantly without code deployment.

## Withdrawal Controls

### Disable Withdrawals (Emergency)
```sql
UPDATE system_settings 
SET withdrawals_enabled = false, updated_at = NOW() 
WHERE id = 'main';
```

### Enable Withdrawals
```sql
UPDATE system_settings 
SET withdrawals_enabled = true, updated_at = NOW() 
WHERE id = 'main';
```

### Check Withdrawal Status
```sql
SELECT withdrawals_enabled, updated_at 
FROM system_settings 
WHERE id = 'main';
```

**Effect:** When disabled, all withdrawal requests return HTTP 503 with message "Withdrawals are temporarily disabled for security maintenance".

**Takes Effect:** Immediately (no deployment needed)

---

## Signup Controls

### Disable Account Signups (Emergency)
```sql
UPDATE system_settings 
SET signups_enabled = false, updated_at = NOW() 
WHERE id = 'main';
```

### Enable Account Signups
```sql
UPDATE system_settings 
SET signups_enabled = true, updated_at = NOW() 
WHERE id = 'main';
```

### Check Signup Status
```sql
SELECT signups_enabled, updated_at 
FROM system_settings 
WHERE id = 'main';
```

**Effect:** When disabled, the register page shows "Signups Temporarily Disabled" and blocks all signup attempts (both email and Google OAuth).

**Takes Effect:** Immediately (no deployment needed)

---

## View All System Settings

```sql
SELECT 
  withdrawals_enabled,
  signups_enabled,
  updated_at
FROM system_settings 
WHERE id = 'main';
```

---

## Quick Reference

| Action | Command |
|--------|---------|
| **Disable withdrawals** | `UPDATE system_settings SET withdrawals_enabled = false WHERE id = 'main';` |
| **Enable withdrawals** | `UPDATE system_settings SET withdrawals_enabled = true WHERE id = 'main';` |
| **Disable signups** | `UPDATE system_settings SET signups_enabled = false WHERE id = 'main';` |
| **Enable signups** | `UPDATE system_settings SET signups_enabled = true WHERE id = 'main';` |
| **Check status** | `SELECT withdrawals_enabled, signups_enabled, updated_at FROM system_settings WHERE id = 'main';` |

---

## Emergency Scenarios

### Suspected Attack - Disable Everything
```sql
UPDATE system_settings 
SET 
  withdrawals_enabled = false,
  signups_enabled = false,
  updated_at = NOW()
WHERE id = 'main';
```

### Resume Normal Operations
```sql
UPDATE system_settings 
SET 
  withdrawals_enabled = true,
  signups_enabled = true,
  updated_at = NOW()
WHERE id = 'main';
```

---

## Notes

- All changes take effect immediately (no deployment needed)
- Changes are database-only (no code changes required)
- Default state: Both withdrawals and signups are **enabled**
- Use Supabase SQL Editor or psql to execute these commands
- Always verify changes with a SELECT query after UPDATE

---

## RLS Policy Audit

**As of:** January 2, 2026

**Generated by:** Security audit after balance injection attack
**Attack vector identified:** Permissive UPDATE policy on `profiles` table allowed direct balance manipulation

---

### üî¥ CRITICAL VULNERABILITIES (FIXED 2025-01-02)

#### 1. `connected_accounts` - "allow_connected_accounts_all"
```
cmd: ALL
using_expression: (auth.role() = 'authenticated'::text)
```
**RISK:** ANY authenticated user can create/update/delete connected_accounts for ANY user pair. An attacker could:
1. Create a connected_account linking themselves as primary to any victim
2. Access victim's transactions, activities, posts
3. Transfer funds from victim's account

**STATUS:** ‚úÖ FIXED in `fix_critical_rls_policies_20250102.sql`
- Dropped permissive policy
- INSERT: Only service_role (child creation is server-side)
- SELECT: Only primary_user_id or connected_user_id can view
- DELETE: Only primary_user_id can delete
- Also updated `/api/child-account/route.ts` to use `adminSupabase`

---

#### 2. `posts` - "Post creators, connected accounts, group admins, and fix submit"
```
cmd: UPDATE
using_expression: ... OR (auth.uid() IS NOT NULL) OR ...
```
**RISK:** The clause `(auth.uid() IS NOT NULL)` means ANY authenticated user can update ANY post. This completely bypasses all other restrictions in the policy.

**STATUS:** ‚úÖ FIXED in `fix_critical_rls_policies_20250102.sql`
- Dropped problematic policy
- Recreated with proper restrictions: post owner, connected accounts, group admin only
- Anonymous fix submissions still work via separate policy

---

### üü† MEDIUM RISK

#### 3. `pending_spends` - "pending_spends_insert"
```
cmd: INSERT
with_check_expression: true
```
**RISK:** Anyone can insert pending_spends without validation. Could be used to spam or create fake spend records.

**NOTE:** This may be intentional for device API, but should validate device_id at minimum.

---

#### 4. `pet_orders` - All policies wide open
```
INSERT: with_check_expression: true
SELECT: using_expression: true
UPDATE: using_expression: true
```
**RISK:** No access control. Anyone can view/create/modify any pet order.

**RECOMMENDATION:** Add user ownership checks if orders contain sensitive data.

---

#### 5. `transactions` - INSERT policy
```
cmd: INSERT
with_check_expression: (auth.uid() = user_id) OR (connected_accounts check)
```
**RISK:** Users can create their own transaction records. This allows:
- Creating fake deposit records
- Creating fake withdrawal records
- Manipulating transaction history

**MITIGATING FACTOR:** Balance is stored on `profiles`, not derived from transactions. Trigger now blocks balance manipulation.

**RECOMMENDATION:** Consider making transactions INSERT only via service_role.

---

#### 6. `transactions` - UPDATE policy
```
cmd: UPDATE  
using_expression: (auth.uid() = user_id) OR (connected_accounts check)
```
**RISK:** Users can modify their own transactions (status, amount, memo).

**RECOMMENDATION:** Make transactions append-only (remove UPDATE policy) or restrict to only certain fields (memo).

---

### üü° LOW RISK / REVIEW NEEDED

#### 7. `profiles` - UPDATE policy (FIXED)
```
cmd: UPDATE
using_expression: (id = auth.uid()) OR (connected_accounts check)
```
**STATUS:** ‚úÖ MITIGATED by `prevent_direct_balance_update` trigger
- Trigger blocks non-service_role balance/pet_coins updates
- Policy still allows other profile field updates (name, avatar, etc.) - this is correct behavior

---

#### 8. `activities` - DELETE policy
```
cmd: DELETE
using_expression: (auth.uid() = user_id)
```
**RISK:** Users can delete their activity history. This could be used to hide evidence of suspicious activity.

**RECOMMENDATION:** Consider removing DELETE policy to maintain audit trail.

---

#### 9. `donations` - DELETE policy
```
cmd: DELETE
using_expression: (auth.uid() = donor_user_id)
```
**RISK:** Users can delete donation records after they're created.

**RECOMMENDATION:** Consider making donations append-only.

---

### ‚úÖ CORRECTLY CONFIGURED

| Table | Notes |
|-------|-------|
| `admin_audit_log` | Admin-only via email check |
| `admin_pr_log` | Admin-only via email check |
| `alexa_linked_accounts` | Proper user ownership checks |
| `bitcoin_prices` | Public read, service_role write |
| `devices` | Proper ownership + connected_accounts |
| `donation_pools` | Service role only for mutations |
| `family_members` | Proper user ownership |
| `flappy_bird_game` | Public (intentional for leaderboard) |
| `group_members` | Complex but appropriate group logic |
| `groups` | Proper creator/admin checks |
| `location_hierarchy` | Service role only for mutations |
| `notification_queue` | Service role only |
| `pending_fixes` | Proper fixer_id ownership |
| `post_boosts` | Service role only for mutations |
| `trigger_logs` | Service role only |
| `verifications` | Proper user ownership |

---

### Priority Action Items

1. **CRITICAL:** Fix `connected_accounts` policy - this is exploitable NOW ‚úÖ FIXED
2. **CRITICAL:** Fix `posts` UPDATE policy - remove `(auth.uid() IS NOT NULL)` clause ‚úÖ FIXED
3. **HIGH:** Review `transactions` policies - consider service_role only for INSERT
4. **MEDIUM:** Review `pending_spends` and `pet_orders` policies
5. **LOW:** Consider removing DELETE policies on `activities` and `donations`

---

### SQL to Regenerate RLS Policy Report

```sql
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual AS "using_expression",
  with_check AS "with_check_expression"
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, cmd, policyname;
```
